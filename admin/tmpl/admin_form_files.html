<SCRIPT TYPE="text/javascript" LANGUAGE="JavaScript">

function fieldsetInit(maxfs) {
    for (i = 0; i < maxfs; i++) {
        if ((i+1) != 1) {
            document.getElementById("fieldset"+(i+1)).style.display = "none";
        }
    }
}

function enableFieldset(current, fs, fs_extra, maxtab, maxfs) {
    for (i = 0; i < maxtab; i++) {
        document.getElementById("tabset"+(i+1)).className = "";
    }
    document.getElementById("tabset"+current).className = "active";

    for (i = 0; i < maxfs; i++) {
        if ((i+1) != fs && (i+1) != fs_extra) {
            document.getElementById("fieldset"+(i+1)).style.display = "none";
        }
    }
    if (document.getElementById(fs).style.display !="none"){document.getElementById(fs).style.display = "none";}
    else {document.getElementById(fs).style.display = "block";}

    if (fs_extra != '') {
        if (document.getElementById(fs_extra).style.display !="none"){document.getElementById(fs_extra).style.display = "none";}
        else {document.getElementById(fs_extra).style.display = "block"; }
    }

    if (valueCheck(document.forms["vorm"].elements["editor_reload"]) == true) {
        if (current == 2 && document.forms["vorm"].elements["editor_reload"].value == 0) {
            document.forms["vorm"].elements["editor_reload"].value = 1;
            document.all.contentFreim.src = document.forms["vorm"].elements["editor_src"].value;
        }
    }

    return;
}

function fieldJump(current, maxtab, jumpto) {
    for (i = 0; i < maxtab; i++) {
        document.getElementById("tabset"+(i+1)).className = "";
    }
    document.getElementById("tabset"+current).className = "active";

    document.location = jumpto;

    return;
}

function enableSingleFieldset(fs) {
    if (fs != '') {
        if (document.getElementById(fs).style.display !="none"){document.getElementById(fs).style.display = "none";}
        else {document.getElementById(fs).style.display = "block"; }
    }
    return;
}

function valueCheck(objToTest) {
    if (null == objToTest) {
        return false;
    }
    if ("undefined" == typeof(objToTest) ) {
        return false;
    }
    return true;
}

</SCRIPT>
<script type="text/javascript" src="../js/file_uploader.js"></script>
<form id="vorm" method="post" action="<TPL:PHP_SELF>" <TPL:ENCTYPE> class="formpanel" name="vorm">

<TPL_SUB:INFO>
    <fieldset title="<TPL:TITLE>" <TPL:STYLE>>
    <legend><TPL:TITLE></legend>
        <table class="inputfield">
        <tr>
            <td><img src="pic/bullet_<TPL:TYPE>.gif" alt="" border="0"></td>
            <td><label for="action" class="left"><TPL:INFO></label></td>
        </tr>
        </table>
    </fieldset>
</TPL_SUB:INFO>

<TPL_SUB:FIELDSET>
    <fieldset id="fieldset<TPL:ID>" title="<TPL:TITLE>" <TPL:STYLE>>
    <legend><TPL:TITLE></legend>
        <table class="inputfield" id="file_table">
        <tr>
            <td align="left" colspan="3" id="btBrowse" height="40px"><TPL:TXT_admin_files|browse></td>
        </tr>
        <tr>
            <td><label for="action" class="left"><font color="<TPL:COLOR>"><TPL:TXT_admin_files|file></font>&nbsp;</label></td>
            <td><label for="action" class="left"><font color="<TPL:COLOR>"><TPL:TXT_admin_files|text></font>&nbsp;</label></td>
            <td></td>
        </tr>
        <TPL_SUB:MAIN>
        <tr id="details_row">
            <td align="left"><label for="action" class="left"><font color="<TPL:COLOR>"><TPL:DESC>:</font>&nbsp;</label></td>
            <td align="left"><TPL:FIELD>&nbsp;<label for="action" class="left"><TPL:EXTRA></label></td>
            <td align="left">&nbsp;</td>
        </tr>
        </TPL_SUB:MAIN>
        <TPL_SUB:BUTTONS>
        <tr>
            <td align="left"><label for="action" class="left"><font color="<TPL:COLOR>"><TPL:DESC>:</font>&nbsp;</label></td>
            <td aling="left" colspan="2">
                <table border="0">
                    <tr>
                        <td align="left"><TPL:FIELD></td>
                        <td align="left"><TPL:EXTRA></td>
                    </tr>
                </table>
            </td>
        </tr>
        </TPL_SUB:BUTTONS>
        <TPL_SUB:EXTERN>
        <tr>
            <td align="left"><label for="action" class="left"><font color="<TPL:COLOR>"><TPL:DESC>:</font>&nbsp;</label></td>
            <td align="left"><TPL:FIELD></td>
            <td align="left"><label for="action" class="left"><TPL:EXTRA></label></td>
        </tr>
        </TPL_SUB:EXTERN>
        <TPL_SUB:NOTHING>
        <table class="inputfield" width="100%">
        <tr>
            <td align="left" colspan="3"><TPL:FIELD></td>
        </tr>
        </table>
        </TPL_SUB:NOTHING>
        </table>

    </fieldset>
</TPL_SUB:FIELDSET>

        <TPL_SUB:NOTHING>
        <table class="inputfield" width="100%">
        <tr>
            <td align="left" colspan="3"><TPL:FIELD></td>
        </tr>
        </table>
        </TPL_SUB:NOTHING>

<TPL_SUB:HIDDEN>
    <input type="hidden" name="<TPL:NAME>" value="<TPL:VALUE>">
</TPL_SUB:HIDDEN>

<p></p>
<script type="text/javascript" src="../js/swfobject.js"></script>
<script type="text/javascript">
    var version = deconcept.SWFObjectUtil.getPlayerVersion();
    if (version["major"] < 8 /*|| (navigator.appName.indexOf("Microsoft") == -1 && document.location.protocol != 'http:')*/) {
        document.location = 'files_admin.php?show=add_single';
    }
</script>

<script type="text/javascript" src="../js/ext/adapter/yui/yui-utilities.js"></script>
<script type="text/javascript" src="../js/ext/adapter/yui/ext-yui-adapter.js"></script>
<script type="text/javascript" src="../js/ext/ext-all.js"></script>
<script type="text/javascript" src="../js/modera/MessageBox.js"></script>

<link rel="stylesheet" type="text/css" href="../js/ext/resources/css/ext-all.css" />
<link rel="stylesheet" type="text/css" href="../js/ext/resources/css/ytheme-gray.css" />

<script type="text/javascript">
    var mb;
    var file_table = document.getElementById("file_table");
    var details_row = document.getElementById("details_row");

    var fileUploader;

    var filesCount = 0;


    function removeNode(obj) {
        var parent;
        parent = obj.parentNode;
        while (obj.childNodes.length > 0) {
            removeNode(obj.childNodes[obj.childNodes.length - 1]);
        }
        var tag = obj.tagName;
        parent.removeChild(obj);
    }

    function getCookie(sName) {
        // cookies are separated by semicolons
        var aCookie = document.cookie.split("; ");
        for (var i=0; i < aCookie.length; i++) {
            // a name/value pair (a crumb) is separated by an equal sign
            var aCrumb = aCookie[i].split("=");
            if (sName == aCrumb[0])
            return unescape(aCrumb[1]);
        }

        // a cookie with the requested name does not exist
        return null;
    }

Ext.onReady(function() {

    var butparent = document.getElementById('btBrowse');

    fileUploader = new FileUploader(butparent,document.forms['vorm'].elements['max_size'].value);

    fileUploader.onAddFile = function(file) {
        filesCount++;
        var row = document.createElement('TR');
        row.file = file;
        file_table.tBodies[0].insertBefore(row, details_row);
        var cell = document.createElement('TD');
        row.appendChild(cell);
        cell.innerHTML = '<label for="action" class="left"><font color="<TPL:COLOR>">' + file.name + '</font>&nbsp;</label>';
        var cell = document.createElement('TD');
        row.appendChild(cell);
        var input = document.createElement('INPUT');
        input.type = "text";
        input.name = "description[" + file.id + "]";
        cell.appendChild(input);
        row.textInput = input;
        var cell = document.createElement('TD');
        row.appendChild(cell);
        cell.innerHTML = '<a href="javascript:if (confirm(\'<TPL:TXT_admin_files|delete_file>\')) fileUploader.deleteFile(' + row.file.id + ')"><img src="/admin/pic/delete.gif" border="0" width="9px" height="11px"/></a>';
    }

    fileUploader.onDelete = function(id) {
        var i;
        filesCount--;
        for (i = 1; i < file_table.tBodies[0].childNodes.length; i++) {
            if (file_table.tBodies[0].childNodes[i].file && file_table.tBodies[0].childNodes[i].file.id == id) {
                removeNode(file_table.tBodies[0].childNodes[i]);
                break;
            }
        }
    }

    fileUploader.onProgress = function(currentIndex, count, currentPos, totalPos) {
        mb.updateProgress(currentPos / 100, '<TPL:TXT_admin_files|uploading> ' + currentIndex + ' <TPL:TXT_admin_files|of> ' + count);
        mb.updateProgress2(totalPos / 100);
    }

    fileUploader.onComplete = function(url) {

        mb.updateText('<TPL:TXT_admin_files|saving>');
        document.getElementById("vorm").elements["do"].value = "finish_upload";
        document.getElementById("vorm").submit();

    }

    fileUploader.buttonDisplayed = function(type) {

        if (type) {
            this.flash.style.left = "";
            this.flash.style.width ="";
            this.flash.style.height = "";
        } else {
            this.flash.style.width = "0px";
            this.flash.style.height = "0px";
            this.flash.style.left   = "-400px";
        }
    }

    fileUploader.onError = function(type, files, error) {

        switch (type) {
            case 'http':
               if (error == 506) {
                   alert(files + ' <TPL:TXT_admin_files|error_log_uploading_file> ');
                   this.buttonDisplayed(true);
                   mb.hide();
                   break;
               }
            case 'io':
            case 'security':

                if (error == null) {
                    error = '';
                }

                alert('<TPL:TXT_admin_files|error_uploading_file> ' + files + error);
                this.buttonDisplayed(true);
                mb.hide();
                break;
            case 'size':
                var max_file_size = document.forms["vorm"].elements["max_size"].value;
                var tmp = "";
                for (var i = 0; i < files.length; i++) {
                    if (tmp != "") tmp += ", ";
                    tmp += files[i].name;
                }
                if (files.length > 1) {
                    tmp = '<TPL:TXT_admin_files|sizes_of_files> ' + tmp + ' <TPL:TXT_admin_files|are_invalid>.';
                } else {
                    tmp = '<TPL:TXT_admin_files|size_of_file> ' + tmp + ' <TPL:TXT_admin_files|is_invalid>.';
                }
                tmp += ' <TPL:TXT_admin_files|file_size_should_be_from> 1 <TPL:TXT_admin_files|till> ' + max_file_size + ' <TPL:TXT_admin_files|bytes>';
                alert(tmp);
                this.buttonDisplayed(true);
            break;
        }
    }

});


    function startUpload() {
        if (filesCount <= 0) {
            alert('<TPL:TXT_admin_files|no_selected_files>');
            return;
        }
        fileUploader.buttonDisplayed(false);
        mb = Modera.MessageBox.show({
            title:'<TPL:TXT_admin_files|please_wait>',
            msg:'<TPL:TXT_admin_files|starting>',
            width:240,
            progress2:true,
            closable:false
        });
        var form_data = new Object;
        var form = document.getElementById('vorm');
        var conn = new Ext.data.Connection();
        var i;
        var el;
        for (i = 0; i < form.elements.length; i++) {
            el = form.elements[i];
            if (el.type != 'checkbox' || el.checked) {
                form_data[el.name] = el.value;
            }
        }
        form_data['do'] = 'prepare_upload';
        conn.request({
            url: form.action,
            params: form_data,
            method: 'POST',
            callback: uploadFiles
        });
    }

    function uploadFiles() {
        var port = document.location.port;
        if (port == '') {
            if (document.location.protocol == 'http:') {
                port = '80';
            } else {
                port = '443';
            }
        }
        var url = document.location.protocol + '//' + document.location.hostname + ':' + port + document.location.pathname;
        fileUploader.startUpload(url + "?show=add&ADM_SESS_SID=" + getCookie("ADM_SESS_SID") + "&ADM_LANG_SID=" + getCookie("ADM_LANG_SID") + "&form_id=" + document.getElementById('vorm').elements['form_id'].value + "&do=savefile&file=");
    }


</script>
<div class="buttonbar">
    <button type="button" onclick="startUpload()"><img src="pic/button_accept.gif" alt="" border="0"><TPL:SENDBUTTONTXT></button>
</div>

</form>