<?php
set_time_limit(0);
require_once("../class/config.php");
require_once(SITE_PATH . "/class/common.php");

$old_error_handler = set_error_handler("userErrorHandler");
hokusPokus();

require_once(SITE_PATH . "/class/".DB_TYPE.".class.php");
require_once(SITE_PATH . "/class/language.class.php");
require_once(SITE_PATH . "/class/text.class.php");
require_once(SITE_PATH . "/class/templatef.class.php");
require_once(SITE_PATH . "/class/Database.php");
require_once(SITE_PATH . "/class/admin.session.class.php");
require_once(SITE_PATH . "/class/IsicCommon.php");
require_once(SITE_PATH . "/class/IsicDB.php");
require_once(SITE_PATH . "/class/Isic/IsicUnitedTicketsSync.php");

// ##############################################################
// init main variables

$db = new db;
$db->connect();
$sq = new sql;
$sq2 = new sql;

$sq->con = $db->con;
$database = new Database($sq);
load_site_settings($database);
$data = $data_settings = $site_settings;

// init language object
$lan = new Language($database, '');
$language = $lan->lan();
$GLOBALS["language"] = &$language;


class FakeCard {
    private $cards = array(
//        364157 => '9233731680140008261',
//        368735 => '9233731680140052798',
//        383856 => '9233731680106051784',
//        390268 => '9233731680108002349',

        375611 => '9233731680106054614',
        383077 => '9233731680101000191',

//        381804 => '9233731680101000043',
//        383078 => '9233731680101000209',
//        383079 => '9233731680101000217',
//        383080 => '9233731680101000225',
//        383081 => '9233731680101000233',
//        383082 => '9233731680101000241',
//        383560 => '9233731680101000266',
//        383794 => '9233731680101000274',
//        383795 => '9233731680101000282',
//        383970 => '9233731680101000290',
//        383971 => '9233731680101000308',
//        383972 => '9233731680101000316',
//        384173 => '9233731680101000324',
//        384678 => '9233731680101000779',
//        384679 => '9233731680101000787',
//        385079 => '9233731680120018406',
//        385235 => '9233731680101000498',
//        385236 => '9233731680101000506',
//        385237 => '9233731680101000514',
//        385238 => '9233731680101000522',
//        385239 => '9233731680101000530',
//        385240 => '9233731680101000548',
//        385241 => '9233731680101000555',
//        385413 => '9233731680101000688',
//        385414 => '9233731680101000696',
//        385415 => '9233731680101000704',
//        385417 => '9233731680101000720',
//        385865 => '9233731680101000803',
//        386356 => '9233731680101001009',
//        386358 => '9233731680101001025',
//        386359 => '9233731680101001033',
//        386360 => '9233731680101001041',
//        389248 => '9233731680109013345',
//        389254 => '9233731680120047256',
//        389257 => '9233731680120047280',
//        389259 => '9233731680120047306',
//        389270 => '9233731680108002117',
//        389280 => '9233731680110015982',
//        389293 => '9233731680150026832',
//        389294 => '9233731680120047462',
//        389297 => '9233731680120047496',
//        389402 => '9233731680108002141',
//        389404 => '9233731680110016006',
//        389416 => '9233731680109013360',
//        389427 => '9233731680150026899',
//        389446 => '9233731680120047884',
//        389458 => '9233731680120048007',
//        389467 => '9233731680120048098',
//        389472 => '9233731680120048148',
//        389473 => '9233731680120048155',
//        389478 => '9233731680120048205',
//        389489 => '9233731680120048312',
//        389490 => '9233731680120048320',
//        389536 => '9233731680110016014',
//        389539 => '9233731680120048353',
//        389559 => '9233731680120048429',
//        389565 => '9233731680120048486',
//        389570 => '9233731680120048536',
//        389575 => '9233731680120048585',
//        389577 => '9233731680150026980',
//        389604 => '9233731680109013410',
//        389606 => '9233731680109013436',
//        389608 => '9233731680109013451',
//        389610 => '9233731680109013477',
//        389639 => '9233731680150027053',
//        389640 => '9233731680120048619',
//        389643 => '9233731680120048643',
//        389648 => '9233731680120048692',
//        389705 => '9233731680120048775',
//        389714 => '9233731680120048866',
//        389715 => '9233731680120048874',
//        389718 => '9233731680120048908',
//        389719 => '9233731680120048916',
//        389723 => '9233731680120048957',
//        389738 => '9233731680120049104',
//        389742 => '9233731680120049146',
//        389746 => '9233731680120049187',
//        389753 => '9233731680120049252',
//        389755 => '9233731680120049278',
//        389831 => '9233731680120049393',
//        389835 => '9233731680120049435',
//        389841 => '9233731680150027210',
//        389859 => '9233731680110016071',
//        389875 => '9233731680150027251',
//        389876 => '9233731680150027269',
//        389965 => '9233731680110016170',
//        389976 => '9233731680120049625',
//        389988 => '9233731680120049674',
//        389993 => '9233731680120049724',
//        390049 => '9233731680108002323',
//        390050 => '9233731680108002331',
//        390057 => '9233731680120049849',
//        390068 => '9233731680120049955',
//        390072 => '9233731680120049997',
//        390073 => '9233731680120050003',
//        390076 => '9233731680120050037',
//        390085 => '9233731680120050128',
//        390086 => '9233731680120050136',
//        390092 => '9233731680120050193',
//        390106 => '9233731680109013501',
//        390111 => '9233731680109013550',
//        390115 => '9233731680150027434',
//        390120 => '9233731680150027483',
//        390158 => '9233731680120050243',
//        390160 => '9233731680120050268',
//        390170 => '9233731680120050367',
//        390176 => '9233731680150027541',
//        390181 => '9233731680150027590',
//        390207 => '9233731680150027764',
//        390214 => '9233731680150027830',
//        390248 => '9233731680109013576',
//        390249 => '9233731680109013584',
//        390251 => '9233731680109013600',
//        390253 => '9233731680109013626',
//        390254 => '9233731680109013634',
//        390261 => '9233731680120050425',
//        390266 => '9233731680120050474',
//        390270 => '9233731680120050482',
//        390271 => '9233731680120050490',
//        390317 => '9233731680120050797',
//        390330 => '9233731680150028101',
//        390411 => '9233731680110016451',
//        390412 => '9233731680120050847',
//        390413 => '9233731680120050854',
//        390433 => '9233731680120051050',
//        390438 => '9233731680120051100',
//        390480 => '9233731680109013907',
//        390587 => '9233731680120051167',
//        390589 => '9233731680120051183',
//        390614 => '9233731680120051233',
//        390626 => '9233731680120051357',
//        390628 => '9233731680120051373',
//        390634 => '9233731680120051431',
//        390734 => '9233731680108002398',
//        390736 => '9233731680120051456',
//        390740 => '9233731680120051498',
//        390760 => '9233731680150028366',
//        390773 => '9233731680120051571',
//        390779 => '9233731680120051639',
//        390786 => '9233731680120051704',
//        390899 => '9233731680110016741',
//        390912 => '9233731680110016873',
//        390916 => '9233731680110016915',
//        390933 => '9233731680120052397',
//        390978 => '9233731680108002430',
//        390979 => '9233731680110016923',
//        390998 => '9233731680120052231',
//        391053 => '9233731680120052132',
//        391055 => '9233731680120052157',
//        391124 => '9233731680120052645',
//        391125 => '9233731680120052652',
//        391139 => '9233731680110016956',
//        391147 => '9233731680109014152',
//        391159 => '9233731680109014277',
//        391165 => '9233731680109014335',
//        391166 => '9233731680109014343',
//        391171 => '9233731680109014392',
//        391173 => '9233731680109014418',
//        391174 => '9233731680109014426',
//        391175 => '9233731680109014434',
//        391177 => '9233731680109014459',
//        391220 => '9233731680108002448',
//        391235 => '9233731680109014103',
//        391240 => '9233731680120052496',
//        391241 => '9233731680120052504',
//        391266 => '9233731680108002471',
//        391298 => '9233731680109014509',
//        391310 => '9233731680120052819',
//        391331 => '9233731680120052843',
//        391334 => '9233731680120052876',
//        391335 => '9233731680120052884',
//        391365 => '9233731680120052892',
//        391366 => '9233731680120052900',
//        391367 => '9233731680120052918',
    );

    public function getRecord($id) {
        if (array_key_exists($id, $this->cards)) {
            return array('pan_number' => $this->cards[$id]);
        }
        return null;
    }
}

$isicDbCards = new FakeCard();
$isicDbCardDataSync = IsicDB::factory('CardDataSync');
$unitedTicketsSync = new IsicUnitedTicketsSync();

echo "<pre>\n";
echo date('H:i:s') . "\n";
$records = $isicDbCardDataSync->getScheduledRecords();
foreach ($records as $record) {
    echo $record['record_type'] . ': ' . $record['record_id'];

    if ($record['tries'] >= $isicDbCardDataSync->getSyncMaxTries()) {
        echo ": max tries exceeded, skipping\n";
        continue;
    }

    if ($record['record_type'] == $isicDbCardDataSync->getRecordTypeCard()) {
        $cardRecord = $isicDbCards->getRecord($record['record_id']);
        if (!$cardRecord) {
            echo 'unknown record: ' , $record['record_id'] . "\n";
            continue;
        }
        $cardRecord['transaction_id'] = $record['id'];
    } else {
        echo ": unknown record type, skipping\n";
        continue;
    }

    $sendResult = null;
    switch ($record['sync_type_id']) {
        case $isicDbCardDataSync->getSyncTypeDeactivate():
            echo ': deactivation';
            $sendResult = $unitedTicketsSync->sendDeactivationMessage($cardRecord);
        break;
        default:
            echo ': unknown';
        break;
    }

    if ($sendResult !== null) {
        $data = $record;
        $data['success'] = $sendResult ? 1 : 0;
        $data['request'] = $unitedTicketsSync->getLastUrl();
        $data['response'] = $unitedTicketsSync->getRawResponse();
        $data['tries']++;
        $isicDbCardDataSync->updateRecord($record['id'], $data);
        echo ': ' . ($sendResult ? 'OK' : 'ERROR');
        if (!$sendResult) {
            IsicMail::sendCardSyncUTFailedNotification($unitedTicketsSync->getLastUrl(), $unitedTicketsSync->getRawResponse());
        }
    }
    echo "\n";
}

echo 'done ...' . date('H:i:s');
echo "\n</pre>\n";
